# GitHub Actions å·¥ä½œæµï¼šæ„å»ºå’Œæ¨é€ Docker é•œåƒ
# æ­¤å·¥ä½œæµç”¨äºè‡ªåŠ¨åŒ–æ„å»º FastAPI åº”ç”¨çš„ Docker é•œåƒå¹¶æ¨é€åˆ° Docker Hub
name: Build and Push Docker Image

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ° main/master åˆ†æ”¯æˆ–åˆ›å»ºæ ‡ç­¾æ—¶è§¦å‘
on:
  push:
    branches: [ main, master ]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
    tags: [ 'v*' ]              # æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  pull_request:
    branches: [ main, master ]  # å¯¹ä¸»åˆ†æ”¯çš„ PR æ—¶è§¦å‘ï¼ˆä»…æ„å»ºä¸æ¨é€ï¼‰

# ç¯å¢ƒå˜é‡å®šä¹‰
env:
  REGISTRY: docker.io          # Docker æ³¨å†Œè¡¨åœ°å€
  IMAGE_NAME: fastapi-demo     # Docker é•œåƒåç§°

jobs:
  build-and-push:
    runs-on: ubuntu-latest     # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu è¿è¡Œå™¨
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v4  # ä½¿ç”¨å®˜æ–¹åŠ¨ä½œæ£€å‡ºä»£ç åˆ°è¿è¡Œå™¨

    # æ­¥éª¤2ï¼šè®¾ç½® Docker Buildx
    # Buildx æ˜¯ Docker çš„å¢å¼ºæ„å»ºå·¥å…·ï¼Œæ”¯æŒå¤šå¹³å°æ„å»ºå’Œé«˜çº§åŠŸèƒ½
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # æ­¥éª¤3ï¼šç™»å½•åˆ° Docker Hub
    # åªæœ‰åœ¨é PR äº‹ä»¶æ—¶æ‰ç™»å½•ï¼ˆPR åªæ„å»ºä¸æ¨é€ï¼‰
    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}           # æ³¨å†Œè¡¨åœ°å€
        username: ${{ secrets.DOCKER_USERNAME }} # ä» GitHub Secrets è·å–ç”¨æˆ·å
        password: ${{ secrets.DOCKER_PASSWORD }} # ä» GitHub Secrets è·å–å¯†ç 

    # æ­¥éª¤4ï¼šç”Ÿæˆç‰ˆæœ¬å·
    # è‡ªåŠ¨ç”Ÿæˆè¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼Œæ ¼å¼ä¸º v1.0.BUILD_NUMBER
    - name: Generate version number
      id: version
      run: |
        # ç”Ÿæˆè¯­ä¹‰åŒ–ç‰ˆæœ¬å· v1.0.BUILD_NUMBER
        VERSION="v1.0.${GITHUB_RUN_NUMBER}"     # ä½¿ç”¨ GitHub è¿è¡Œç¼–å·
        echo "version=${VERSION}" >> $GITHUB_OUTPUT  # è¾“å‡ºç‰ˆæœ¬å·ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "Generated version: ${VERSION}"

    # æ­¥éª¤5ï¼šæå–é•œåƒå…ƒæ•°æ®
    # æ ¹æ®è§¦å‘æ¡ä»¶ç”Ÿæˆé€‚å½“çš„é•œåƒæ ‡ç­¾
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        # å®Œæ•´çš„é•œåƒåç§°ï¼šregistry/username/image_name
        images: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
        tags: |
          # å¦‚æœæ˜¯é»˜è®¤åˆ†æ”¯ï¼ˆmain/masterï¼‰ï¼Œåˆ™æ‰“ä¸Š latest æ ‡ç­¾
          type=raw,value=latest,enable={{is_default_branch}}
          # å¦‚æœæ˜¯é»˜è®¤åˆ†æ”¯ï¼Œåˆ™æ‰“ä¸Šç‰ˆæœ¬å·æ ‡ç­¾
          type=raw,value=${{ steps.version.outputs.version }},enable={{is_default_branch}}

    # æ­¥éª¤6ï¼šæ„å»ºå’Œæ¨é€ Docker é•œåƒ
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .                               # æ„å»ºä¸Šä¸‹æ–‡ä¸ºå½“å‰ç›®å½•
        file: ./Dockerfile                       # æŒ‡å®š Dockerfile è·¯å¾„
        push: ${{ github.event_name != 'pull_request' }}  # åªæœ‰é PR æ—¶æ‰æ¨é€
        tags: ${{ steps.meta.outputs.tags }}    # ä½¿ç”¨ç”Ÿæˆçš„æ ‡ç­¾
        labels: ${{ steps.meta.outputs.labels }} # ä½¿ç”¨ç”Ÿæˆçš„æ ‡ç­¾
        cache-from: type=gha                     # ä» GitHub Actions ç¼“å­˜è¯»å–
        cache-to: type=gha,mode=max             # å†™å…¥ GitHub Actions ç¼“å­˜

    # æ­¥éª¤7ï¼šæ„å»ºæ€»ç»“
    # æ˜¾ç¤ºæ„å»ºå®Œæˆçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬å·å’Œé•œåƒæ ‡ç­¾
    - name: Build Summary
      if: github.event_name != 'pull_request'   # åªæœ‰é PR æ—¶æ‰æ˜¾ç¤º
      run: |
        echo "ğŸš€ æ„å»ºå®Œæˆï¼"
        echo "ğŸ“¦ ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}"
        echo "ğŸ·ï¸ é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.tags }}" 